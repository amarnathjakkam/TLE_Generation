<!doctype html>
<html lang="en">
<head>
  <meta charset="utf-8" />
  <meta name="viewport" content="width=device-width,initial-scale=1" />
  <title>TLE → Az/El CSV Generator</title>
  <style>
    :root{--gap:8px}
    body{font-family:system-ui,Segoe UI,Roboto,"Helvetica Neue",Arial;margin:16px}
    label{display:block;margin-top:8px}
    input,textarea,select,button{padding:6px;margin-top:4px;box-sizing:border-box}
    input,select,textarea{width:100%}
    .row{display:flex;gap:var(--gap);align-items:flex-end}
    .row > *{flex:1}
    pre{background:#f6f8fa;padding:10px;border-radius:6px;overflow:auto}
    button{margin-top:8px;padding:8px 12px}
    small{color:#666}
    .controls{display:grid;grid-template-columns:1fr 1fr 1fr;gap:var(--gap)}
    table{border-collapse:collapse;width:100%;margin-top:12px}
    th,td{border:1px solid #ddd;padding:6px;text-align:center;font-family:monospace}
    th{background:#f0f0f0}
    .toolbar{display:flex;gap:8px;align-items:center;margin-top:12px}
    .pager{display:flex;gap:6px;align-items:center}
    .progress{height:8px;background:#eee;border-radius:4px;overflow:hidden}
    .progress > i{display:block;height:100%;background:#4caf50;width:0%}
    .muted{color:#666;font-size:0.9em}
  </style>
</head>
<body>
  <h2>TLE → Azimuth / Elevation CSV (browser)</h2>

  <div style="display:grid;grid-template-columns:1fr 1fr;gap:12px;align-items:start">
    <div>
      <label>TLE name (optional)
        <input id="tleName" placeholder="D091" value="D091" />
      </label>
      <label>TLE line 1
        <input id="tle1" value="1 44078U 19072A   25237.00127315  .00000014  00000-0  40313-4 0  1239"/>
      </label>
      <label>TLE line 2
        <input id="tle2" value="2 44078  98.2808 291.9629 0018719  34.1424  38.1671 14.43768520337337"/>
      </label>

      <div class="row">
        <div>
          <label>Site latitude (°)
            <input id="siteLat" value="17.268660" />
          </label>
        </div>
        <div>
          <label>Site longitude (°)
            <input id="siteLon" value="78.496172" />
          </label>
        </div>
        <div>
          <label>Site altitude (m)
            <input id="siteAlt" value="0" />
          </label>
        </div>
      </div>

      <div style="margin-top:8px">
        <label>Start (UTC) <small>YYYY-MM-DD HH:mm:ss</small>
          <input id="start" value="2025-08-25 03:39:25" />
        </label>
        <label>End (UTC)
          <input id="end" value="2025-08-25 03:54:00" />
        </label>
      </div>

    </div>

    <div>
      <div class="controls">
        <div>
          <label>Resolution (ms)
            <input id="resolution" value="1000" />
          </label>
        </div>
        <div>
          <label>Decimal places for angles
            <input id="decimals" value="3" />
          </label>
        </div>
        <div>
          <label>Rows per page (preview)
            <input id="rowsPerPage" value="200" />
          </label>
        </div>
      </div>

      <div class="row">
        <div>
          <label><input type="checkbox" id="applyRefraction" checked /> Apply atmospheric refraction (Bennett)</label>
        </div>
        <div>
          <label>Temperature (°C) for refraction
            <input id="tempC" value="15" />
          </label>
        </div>
        <div>
          <label>Output filename
            <input id="outputFile" value="tle_output.csv" />
          </label>
        </div>
      </div>

      <div class="toolbar">
        <button id="run">Generate CSV</button>
        <button id="download" disabled>Download full CSV</button>
        <button id="downloadPage" disabled>Download current page</button>
        <div style="flex:1"></div>
        <div class="muted">Rows: <span id="totalRows">0</span></div>
      </div>

      <div style="margin-top:12px">
        <div class="progress" title="generation progress"><i id="progFill"></i></div>
      </div>

    </div>
  </div>

  <h3>Preview (table)</h3>
  <div style="display:flex;gap:12px;align-items:center;">
    <div class="pager">
      <button id="firstPage">« First</button>
      <button id="prevPage">‹ Prev</button>
      <span>Page <strong id="curPage">0</strong> / <strong id="pageCount">0</strong></span>
      <button id="nextPage">Next ›</button>
      <button id="lastPage">Last »</button>
    </div>
    <div style="margin-left:auto" class="muted">Showing <span id="showing">0</span> rows</div>
  </div>

  <div style="overflow:auto;max-height:480px;margin-top:8px;border:1px solid #eee;border-radius:6px;padding:6px">
    <table id="previewTable">
      <thead>
        <tr><th>UTC Time</th><th>Az (°)</th><th>El (°)</th></tr>
      </thead>
      <tbody id="previewBody">
      </tbody>
    </table>
  </div>

  <script src="https://cdnjs.cloudflare.com/ajax/libs/satellite.js/1.3.0/satellite.min.js"></script>
  <script>
    // Utilities
    function parseDateUTC(str) {
      const [d, t] = str.trim().split(' ');
      const [Y, M, D] = d.split('-').map(Number);
      const [h, m, s] = (t||'00:00:00').split(':').map(Number);
      return new Date(Date.UTC(Y, M-1, D, h, m, s));
    }

    function pressureMbarBarometric(hMeters, p0Mbar) {
      const T0 = 288.15; const L  = 0.0065; const g  = 9.80665; const M  = 0.0289644; const R  = 8.3144598;
      return p0Mbar * Math.pow(1.0 - (L * hMeters) / T0, (g * M) / (R * L));
    }

    function refractBennettDeg(altDeg, tempC, pressureMbar) {
      if (altDeg <= -1.0) return altDeg;
      const altRad = altDeg * Math.PI/180.0;
      const R_arcmin = (pressureMbar / 1010.0) * (283.0 / (273.0 + tempC))
                * (1.02 / Math.tan(altRad + (10.3 * Math.PI/180.0) / (altDeg + 5.11)));
      return altDeg + R_arcmin / 60.0;
    }

    // Formatting: exact HH:mm:ss.SSS like Java
    function formatTimeUTC(d) {
      const hh = String(d.getUTCHours()).padStart(2,'0');
      const mm = String(d.getUTCMinutes()).padStart(2,'0');
      const ss = String(d.getUTCSeconds()).padStart(2,'0');
      const ms = String(d.getUTCMilliseconds()).padStart(3,'0');
      return `${hh}:${mm}:${ss}.${ms}`;
    }

    // state
    let rows = []; // [ [date ISO string, az, el], ... ]
    let currentPage = 1;

    function renderPage(page, rowsPerPage) {
      const tbody = document.getElementById('previewBody');
      tbody.innerHTML = '';
      const total = rows.length;
      const pageCount = Math.max(1, Math.ceil(total / rowsPerPage));
      if (page < 1) page = 1;
      if (page > pageCount) page = pageCount;
      currentPage = page;
      const start = (page-1) * rowsPerPage;
      const end = Math.min(total, start + rowsPerPage);
      for (let i=start;i<end;i++) {
        const tr = document.createElement('tr');
        const r = rows[i];
        const tdTime = document.createElement('td'); tdTime.textContent = r[0]; tr.appendChild(tdTime);
        const tdAz = document.createElement('td'); tdAz.textContent = isNaN(r[1])? '': Number(r[1]).toFixed(Number(document.getElementById('decimals').value)); tr.appendChild(tdAz);
        const tdEl = document.createElement('td'); tdEl.textContent = isNaN(r[2])? '': Number(r[2]).toFixed(Number(document.getElementById('decimals').value)); tr.appendChild(tdEl);
        tbody.appendChild(tr);
      }
      document.getElementById('curPage').textContent = currentPage;
      document.getElementById('pageCount').textContent = pageCount;
      document.getElementById('totalRows').textContent = total;
      document.getElementById('showing').textContent = (end-start);
      // enable/disable pager
      document.getElementById('firstPage').disabled = currentPage===1;
      document.getElementById('prevPage').disabled = currentPage===1;
      document.getElementById('nextPage').disabled = currentPage===pageCount;
      document.getElementById('lastPage').disabled = currentPage===pageCount;
      // enable download page
      document.getElementById('downloadPage').disabled = total===0;
    }

    // download helpers
    function csvFromRows(rs) {
      const lines = ['time_utc,az_deg,el_deg'];
      for (const r of rs) {
        const az = isNaN(r[1])? '': Number(r[1]).toFixed(Number(document.getElementById('decimals').value));
        const el = isNaN(r[2])? '': Number(r[2]).toFixed(Number(document.getElementById('decimals').value));
        lines.push(`${r[0]},${az},${el}`);
      }
      return lines.join('');
    }

    function downloadText(filename, text) {
      const blob = new Blob([text], {type:'text/csv'});
      const url = URL.createObjectURL(blob);
      const a = document.createElement('a'); a.href = url; a.download = filename; document.body.appendChild(a); a.click(); a.remove(); setTimeout(()=>URL.revokeObjectURL(url),1500);
    }

    // main generate routine
    document.getElementById('run').addEventListener('click', async () => {
      rows = [];
      renderPage(1, Number(document.getElementById('rowsPerPage').value || 200));
      document.getElementById('progFill').style.width = '0%';
      document.getElementById('download').disabled = true;
      document.getElementById('downloadPage').disabled = true;

      const tle1 = document.getElementById('tle1').value.trim();
      const tle2 = document.getElementById('tle2').value.trim();
      if (!tle1 || !tle2) { alert('Please provide TLE lines.'); return; }

      const siteLat = parseFloat(document.getElementById('siteLat').value);
      const siteLon = parseFloat(document.getElementById('siteLon').value);
      const siteAltM = parseFloat(document.getElementById('siteAlt').value || '0');
      const start = parseDateUTC(document.getElementById('start').value);
      const end = parseDateUTC(document.getElementById('end').value);
      const resolutionMs = parseInt(document.getElementById('resolution').value, 10) || 1000;
      const decimals = parseInt(document.getElementById('decimals').value, 10) || 3;
      const applyRefraction = document.getElementById('applyRefraction').checked;
      const tempC = parseFloat(document.getElementById('tempC').value) || 15.0;
      const outputFile = document.getElementById('outputFile').value || 'tle_output.csv';

      const pressureMbar = pressureMbarBarometric(siteAltM, 1013.25);
      const satrec = satellite.twoline2satrec(tle1, tle2);

      // estimate iterations and guard large loops
      const maxIter = Math.ceil((end.getTime() - start.getTime()) / resolutionMs) + 1;
      if (maxIter > 500000) {
        if (!confirm('This will generate ' + maxIter + ' rows. Continue?')) return;
      }

      // compute in chunks to keep UI responsive
      const chunkSize = 2000; // number of steps per chunk
      let generated = 0;
      for (let base = start.getTime(); base <= end.getTime(); base += chunkSize * resolutionMs) {
        const chunkEnd = Math.min(end.getTime(), base + (chunkSize-1) * resolutionMs);
        for (let t = base; t <= chunkEnd; t += resolutionMs) {
          const date = new Date(t);
          const pv = satellite.propagate(satrec, date);
          const posEci = pv.position;
          if (!posEci) {
            rows.push([formatTimeUTC(date), NaN, NaN]);
          } else {
            const gmst = satellite.gstimeFromDate(date);
            const posEcf = satellite.eciToEcf(posEci, gmst);
            const observerGd = { longitude: siteLon * Math.PI/180.0, latitude: siteLat * Math.PI/180.0, height: siteAltM/1000.0 };
            const lookAngles = satellite.ecfToLookAngles(observerGd, posEcf);
            let azDeg = lookAngles.azimuth * 180.0/Math.PI; if (azDeg < 0) azDeg += 360.0;
            let elDeg = lookAngles.elevation * 180.0/Math.PI;
            if (applyRefraction) elDeg = refractBennettDeg(elDeg, tempC, pressureMbar);
            rows.push([formatTimeUTC(date), azDeg, elDeg]);
          }
          generated++;
        }
        // update progress and render first page
        const pct = Math.round((generated / maxIter) * 100);
        document.getElementById('progFill').style.width = pct + '%';
        renderPage(1, Number(document.getElementById('rowsPerPage').value || 200));
        // yield to UI thread
        await new Promise(r => setTimeout(r, 8));
      }

      // done
      document.getElementById('progFill').style.width = '100%';
      document.getElementById('download').disabled = false;
      document.getElementById('downloadPage').disabled = false;

      // prepare download handler
      document.getElementById('download').onclick = () => {
        downloadText(outputFile, csvFromRows(rows));
      };
      document.getElementById('downloadPage').onclick = () => {
        const rpp = Number(document.getElementById('rowsPerPage').value || 200);
        const startIndex = (currentPage-1)*rpp; const endIndex = Math.min(rows.length, startIndex + rpp);
        const pageRows = rows.slice(startIndex, endIndex);
        downloadText(outputFile.replace('.csv','_page'+currentPage+'.csv'), csvFromRows(pageRows));
      };

    });

    // pager events
    document.getElementById('firstPage').addEventListener('click', ()=> renderPage(1, Number(document.getElementById('rowsPerPage').value)));
    document.getElementById('prevPage').addEventListener('click', ()=> renderPage(currentPage-1, Number(document.getElementById('rowsPerPage').value)));
    document.getElementById('nextPage').addEventListener('click', ()=> renderPage(currentPage+1, Number(document.getElementById('rowsPerPage').value)));
    document.getElementById('lastPage').addEventListener('click', ()=> {
      const rpp = Number(document.getElementById('rowsPerPage').value||200);
      const pageCount = Math.max(1, Math.ceil(rows.length / rpp)); renderPage(pageCount, rpp);
    });

    // allow changing rowsPerPage to re-render
    document.getElementById('rowsPerPage').addEventListener('change', ()=> renderPage(1, Number(document.getElementById('rowsPerPage').value)));

  </script>
</body>
</html>
